var GA=GA||{};GA.VERSION="0.0.1",GA.plugins=void 0,GA.custom=void 0,GA.create=function(t,e,s,i,r){var o,n={};if(n.canvas=document.createElement("canvas"),n.canvas.setAttribute("width",1*t),n.canvas.setAttribute("height",1*e),n.canvas.style.backgroundColor="black",document.body.appendChild(n.canvas),n.canvas.ctx=n.canvas.getContext("2d"),n.stage=(d(o={}),o.stage=!0,o.width=n.canvas.width,o.height=n.canvas.height,o.x=0,o.y=0,o.parent=void 0,o),n.key=function(){var t={};return t.leftArrow=c(37),t.upArrow=c(38),t.rightArrow=c(39),t.downArrow=c(40),t.space=c(32),t}(),n.buttons=[],n.dragAndDrop=!1,n.draggableSprites=[],n.tweens=[],n.state=void 0,n.load=r||void 0,n.setup=s||void 0,void 0===n.setup)throw new Error("Please supply the setup function in the constructor");function h(){if(requestAnimationFrame(h,n.canvas),void 0===n._fps)l(),n.render(n.canvas,0);else{var t=Date.now(),e=t-n._startTime;for(e>1e3&&(e=n._frameDuration),n._startTime=t,n._lag+=e;n._lag>=n._frameDuration;)a(),l(),n._lag-=n._frameDuration;var s=n._lag/n._frameDuration;n.render(n.canvas,s)}}function a(){n.stage.children.forEach((function(t){!function t(e){e._previousX=e.x;e._previousY=e.y;e.children&&e.children.length>0&&e.children.forEach((function(e){t(e)}))}(t)}))}function l(){if(n.buttons.length>0){n.canvas.style.cursor="auto";for(var t=n.buttons.length-1;t>=0;t--){var e=n.buttons[t];e.update(n.pointer,n.canvas),"over"!==e.state&&"down"!==e.state||e.stage||(n.canvas.style.cursor="pointer")}}if(n.state&&!n.paused&&n.state(),0!==n.updateFunctions.length)for(var s=0;s<n.updateFunctions.length;s++){(0,n.updateFunctions[s])()}}function d(t){t.x=0,t.y=0,t.vx=0,t.vy=0,t.width=0,t.height=0,t.scaleX=1,t.scaleY=1,t.pivotX=.5,t.pivotY=.5,t.rotation=0,t.visible=!0,t.parent=void 0,t.stage=!1,t.shadow=!1,t.shadowColor="rgba(100, 100, 100, 0.5)",t.shadowOffsetX=3,t.shadowOffsetY=3,t.shadowBlur=3,t.blendMode=void 0,t._alpha=1,t._draggable=void 0,t._layer=0,t._circular=!1,t._interactive=!1,t._previousX=void 0,t._previousY=void 0,t.children=[],t.addChild=function(e){e.parent&&e.parent.removeChild(e),e.parent=t,t.children.push(e)},t.removeChild=function(e){if(e.parent!==t)throw new Error(e+"is not a child of "+t);t.children.splice(t.children.indexOf(e),1)},t.add=function(e){var s=Array.prototype.slice.call(arguments);s.length>1?s.forEach((function(e){t.addChild(e)})):t.addChild(s[0])},t.remove=function(e){var s=Array.prototype.slice.call(arguments);s.length>1?s.forEach((function(e){t.removeChild(e)})):t.removeChild(s[0])},t.setPosition=function(e,s){t.x=e,t.y=s};var e=t;t.putTop=function(s,i,r){i=i||0,r=r||0,s.x=e.x+e.halfWidth-s.halfWidth+i,s.y=e.y-s.height+r,t.compensateForParentPosition(e,s)},t.compensateForParentPosition=function(t,e){0===e.parent.gx&&0===e.parent.gy||(e.x-=t.gx,e.y-=t.gy)},Object.defineProperties(t,{gx:{get:function(){return this.parent?this.x+this.parent.gx:this.x},enumerable:!0,configurable:!0},gy:{get:function(){return this.parent?this.y+this.parent.gy:this.y},enumerable:!0,configurable:!0},position:{get:function(){return{x:t.x,y:t.y}},enumerable:!0,configurable:!0},halfWidth:{get:function(){return t.width/2},enumerable:!0,configurable:!0},halfHeight:{get:function(){return t.height/2},enumerable:!0,configurable:!0}})}function c(t){var e={};return e.code=t,e.isDown=!1,e.isUp=!0,e.press=void 0,e.release=void 0,e.downHandler=function(t){t.keyCode===e.code&&(e.isUp&&e.press&&e.press(),e.isDown=!0,e.isUp=!1),t.preventDefault()},e.upHandler=function(t){t.keyCode===e.code&&(e.isDown&&e.release&&e.release(),e.isDown=!1,e.isUp=!0),t.preventDefault()},window.addEventListener("keydown",e.downHandler.bind(e),!1),window.addEventListener("keyup",e.upHandler.bind(e),!1),e}return n.assetFilePaths=i||void 0,n.paused=!1,n._fps=60,n._startTime=Date.now(),n._frameDuration=1e3/n._fps,n._lag=0,n.interpolate=!0,n.updateFunctions=[],n.scale=1,n.start=function(){n.assetFilePaths?(n.assets.whenLoaded=function(){n.state=void 0,n.setup()},n.assets.load(n.assetFilePaths),n.load&&(n.state=n.load)):n.setup(),h()},n.pause=function(){n.paused=!0},n.resume=function(){n.paused=!1},Object.defineProperties(n,{fps:{get:function(){return n._fps},set:function(t){n._fps=t,n._startTime=Date.now(),n._frameDuration=1e3/n._fps},enumerable:!0,configurable:!0},backgroundColor:{set:function(t){n.canvas.style.backgroundColor=t},enumerable:!0,configurable:!0}}),n.remove=function(t){var e=Array.prototype.slice.call(arguments);if(e[0]instanceof Array){var s=e[0];if(s.length>0)for(var i=s.length-1;i>=0;i--){var r=s[i];r.parent.removeChild(r),s.splice(s.indexOf(r),1)}}else e.length>1?e.forEach((function(t){t.parent.removeChild(t)})):e[0].parent.removeChild(e[0])},n.rectangle=function(t,e,s,i,r,o,h){var a={};return d(a),a.mask=!1,a.width=t||32,a.height=e||32,a.fillStyle=s||"red",a.strokeStyle=i||"none",a.lineWidth=r||0,a.x=o||0,a.y=h||0,n.stage.addChild(a),a.render=function(t){t.strokeStyle=a.strokeStyle,t.lineWidth=a.lineWidth,t.fillStyle=a.fillStyle,t.beginPath(),t.rect(-a.width*a.pivotX,-a.height*a.pivotY,a.width,a.height),!0===a.mask?t.clip():("none"!==a.strokeStyle&&t.stroke(),"none"!==a.fillStyle&&t.fill())},a},n.text=function(t,e,s,i,r){var o={};return d(o),o.content=t||"Hello!",o.font=e||"12px sans-serif",o.fillStyle=s||"red",o.textBaseline="top",Object.defineProperties(o,{width:{get:function(){return n.canvas.ctx.measureText(o.content).width},enumerable:!0,configurable:!0},height:{get:function(){return n.canvas.ctx.measureText("M").width},enumerable:!0,configurable:!0}}),n.stage.addChild(o),o.x=i||0,o.y=r||0,o.render=function(t){t.strokeStyle=o.strokeStyle,t.lineWidth=o.lineWidth,t.fillStyle=o.fillStyle,0===o.width&&(o.width=t.measureText(o.content).width),0===o.height&&(o.height=t.measureText("M").width),t.translate(-o.width*o.pivotX,-o.height*o.pivotY),t.font=o.font,t.textBaseline=o.textBaseline,t.fillText(o.content,0,0)},o},n.sprite=function(t){var e={};if(void 0===t)throw new Error("Sprites require a source");return d(e),e.frames=[],e.loop=!0,e._currentFrame=0,e.setTexture=function(t){t.image||t instanceof Array||(e.tilesetFrame=n.assets[t],e.source=e.tilesetFrame.source,e.sourceX=e.tilesetFrame.frame.x,e.sourceY=e.tilesetFrame.frame.y,e.width=e.tilesetFrame.frame.w,e.height=e.tilesetFrame.frame.h,e.sourceWidth=e.tilesetFrame.frame.w,e.sourceHeight=e.tilesetFrame.frame.h)},e.setTexture(t),e.x=0,e.y=0,n.stage.addChild(e),e.render=function(t){t.drawImage(e.source,e.sourceX,e.sourceY,e.sourceWidth,e.sourceHeight,-e.width*e.pivotX,-e.height*e.pivotY,e.width,e.height)},e},n.image=function(t){return n.assets[t]},n.json=function(t){return n.assets[t]},n.render=function(t,e){var s=t.ctx;s.clearRect(0,0,t.width,t.height);for(var i=0;i<n.stage.children.length;i++){r(n.stage.children[i])}function r(i){if(i.visible&&i.gx<t.width+i.width&&i.gx+i.width>=-i.width&&i.gy<t.height+i.height&&i.gy+i.height>=-i.height){if(s.save(),n.interpolate?(void 0!==i._previousX?i.renderX=(i.x-i._previousX)*e+i._previousX:i.renderX=i.x,void 0!==i._previousY?i.renderY=(i.y-i._previousY)*e+i._previousY:i.renderY=i.y):(i.renderX=i.x,i.renderY=i.y),s.translate(i.renderX+i.width*i.pivotX,i.renderY+i.height*i.pivotY),s.globalAlpha=i.alpha,s.rotate(i.rotation),s.scale(i.scaleX,i.scaleY),i.blendMode&&(s.globalCompositeOperation=i.blendMode),i.render&&i.render(s),i.children&&i.children.length>0){s.translate(-i.width*i.pivotX,-i.height*i.pivotY);for(var o=0;o<i.children.length;o++){r(i.children[o])}}s.restore()}}},n.assets={toLoad:0,loaded:0,imageExtensions:["png","jpg","gif","webp"],whenLoaded:void 0,load:function(t){var e=this;e.toLoad=t.length,t.forEach((function(t){var s=t.split(".").pop();if(-1!==e.imageExtensions.indexOf(s)){var i=new Image;i.addEventListener("load",(function(){i.name=t,e[i.name]={source:i,frame:{x:0,y:0,w:i.width,h:i.height}},e.loadHandler()}),!1),i.src=t}}))},loadHandler:function(){this.loaded+=1,this.toLoad===this.loaded&&(this.toLoad=0,this.loaded=0,this.whenLoaded())}},n.keyboard=c,n.makeDisplayObject=d,void 0!==GA.plugins&&GA.plugins(n),void 0!==GA.custom&&GA.custom(n),n},window.GA=GA,window.ga=GA.create;var ga=window.ga;function internal_move(t){t.x+=0|t.vx,t.y+=0|t.vy}function getControls(t){const e=t.keyboard;return{up:e(38),down:e(40),confirm:e(13),C4:e(65),"C#4":e(87),D4:e(83),"D#4":e(69),E4:e(68),F4:e(70),"F#4":e(84),G4:e(71),"G#4":e(89),A4:e(72),"A#4":e(85),B4:e(74),C5:e(75)}}window.GA.custom=function(t){t.randomInt=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},t.randomPick=function(e){return e[t.randomInt(0,e.length-1)]},t.move=function(t){if(t instanceof Array==!1)internal_move(t);else for(var e=0;e<t.length;e++)internal_move(t[e])}};var colors={black:"#000000",white:"#FFFFFF",green:"#00FF00",blue:"#0000FF",red:"#FF0000",lightBlue:"#33FFFF"};const HAPPY=1,NEUTRAL=0,SAD=-1,ANGRY=-2;class Slime{constructor(t,e){this.g=t,this.jumping=!1,this.mood=NEUTRAL,this.parentSprite=e,this.onDoneJumping=()=>{},this.drawSprite()}setMood(t){this.mood=t,this.drawSprite()}resetMood(){this.mood=NEUTRAL,this.drawSprite()}improveMood(){this.mood!==ANGRY&&this.mood<HAPPY&&(this.mood++,this.drawSprite())}worsenMood(){this.mood>ANGRY&&(this.mood--,this.drawSprite())}drawSprite(){let t;switch(this.mood){case HAPPY:t="assets/happy-slime.png";break;case NEUTRAL:t="assets/neutral-slime.png";break;case SAD:t="assets/sad-slime.png";break;case ANGRY:t="assets/angry-slime.png";break;default:throw new Error("Unknown mood")}this.sprite?this.sprite.setTexture(t):this.sprite=this.g.sprite(t),this.parentSprite&&this.parentSprite.putTop(this.sprite),this.sprite.y-=3,this.sprite.scaleX=1.25,this.sprite.scaleY=1.25}jump(t){this.onDoneJumping=t||(()=>{}),this.jumping||this.falling||(this.jumping=!0,this.sprite.vy=-5,this.jumpFrames=.2*this.g.fps)}shake(t){let e=8;let s=1;const i=()=>{this.sprite.x+=2*s,s*=-1,e>0?(e--,setTimeout(i,50)):t()};i()}update(){this.jumping&&(0===this.jumpFrames?(this.jumping=!1,this.falling=!0,this.sprite.vy=10,this.fallFrames=.1*this.g.fps):this.jumpFrames-=1),this.falling&&(0===this.fallFrames?(this.falling=!1,this.sprite.vy=0,this.onDoneJumping()):this.fallFrames-=1),this.g.move(this.sprite)}}class Key{constructor(t,e,s){this.g=t,this.highlightFrames=null,this.drawKey(e,s),this.initSlime()}onCorrectNote(t=(()=>{})){this.slime.jump(()=>{this.slime.improveMood(),t()})}onWrongNote(){this.slime.shake(()=>{this.slime.worsenMood()})}getLabelY(){return this.sprite.y+this.getHeight()-20}drawKey(t,e){this.sprite=this.g.rectangle(this.getWidth(),this.getHeight(),this.getFill(),this.getStroke(),2),this.sprite.x=this.getKeyX(t),this.sprite.y=this.getKeyY(),this.text=this.g.text(e,"16px monospace",this.getTextColor(),this.getLabelX(),this.getLabelY())}initSlime(){this.slime=new Slime(this.g,this.sprite)}highlight(t,e){this.sprite.fillStyle=t,e&&(this.highlightFrames=e*this.g.fps)}update(){0===this.highlightFrames?(this.sprite.fillStyle=this.getFill(),this.highlightFrames=null):this.highlightFrames&&(this.highlightFrames-=1),this.slime.update()}}const scale=1.25,KEY_WIDTH=100,KEY_HEIGHT=375;class WhiteKey extends Key{constructor(t,e,s){super(t,e,s)}getWidth(){return KEY_WIDTH}getHeight(){return KEY_HEIGHT}getFill(){return colors.white}getStroke(){return colors.black}getKeyX(t){return 2+KEY_WIDTH*t}getKeyY(){return 210}getLabelX(){return this.sprite.x+42}getTextColor(){return colors.black}}const KEY_WIDTH$1=50,KEY_HEIGHT$1=250;class BlackKey extends Key{constructor(t,e,s){super(t,e,s)}getWidth(){return KEY_WIDTH$1}getHeight(){return KEY_HEIGHT$1}getFill(){return colors.black}getStroke(){return"#777777"}getKeyX(t){let e=22+(KEY_WIDTH$1+KEY_WIDTH*t);return t>1&&(e+=KEY_WIDTH),e}getKeyY(){return 210}getLabelX(){return this.sprite.x+19}getTextColor(){return colors.white}}class AudioSynth{constructor(){if(this.URL=window.URL||window.webkitURL,this.Blob=window.Blob,!this.URL||!this.Blob)throw new Error("This browser does not support AudioSynth");this._debug=!1,this._bitsPerSample=16,this._channels=1,this._sampleRate=44100,this._volume=32768,this._notes={C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88},this._fileCache=[],this._temp={},this._sounds=[],this._mod=[function(t,e,s,i){return Math.sin(2*Math.PI*(t/e)*s+i)}],this.__init__()}_pack(t,e){return[new Uint8Array([e,e>>8]),new Uint8Array([e,e>>8,e>>16,e>>24])][t]}setSampleRate(t){return this._sampleRate=Math.max(Math.min(0|t,44100),4e3),this._clearCache(),this._sampleRate}getSampleRate(){return this._sampleRate}setVolume(t){return t=parseFloat(t),isNaN(t)&&(t=0),t=Math.round(32768*t),this._volume=Math.max(Math.min(0|t,32768),0),this._clearCache(),this._volume}getVolume(){return Math.round(this._volume/32768*1e4)/1e4}_resizeCache(){for(var t=this._fileCache,e=this._sounds.length;t.length<e;){for(var s=[],i=0;i<8;i++){var r={};for(var o in this._notes)r[o]={};s.push(r)}t.push(s)}}_clearCache(){this._fileCache=[],this._resizeCache()}generate(t,e,s,i){var r=this._sounds[t];if(!r)for(var o=0;o<this._sounds.length;o++)if(this._sounds[o].name==t){r=this._sounds[o],t=o;break}if(!r)throw new Error("Invalid sound or sound ID: "+t);(new Date).valueOf();this._temp={},s|=0,s=Math.min(8,Math.max(1,s));var n=i?parseFloat(i):2;if(void 0===this._notes[e])throw new Error(e+" is not a valid note.");if(void 0!==this._fileCache[t][s-1][e][n])return this._debug&&(new Date).valueOf(),this._fileCache[t][s-1][e][n];var h=this._notes[e]*Math.pow(2,s-4),a=this._sampleRate,l=this._volume,d=this._channels,c=this._bitsPerSample,u=r.attack(a,h,l),g=r.dampen(a,h,l),p=r.wave,m={modulate:this._mod,vars:this._temp},f=0,y=new Uint8Array(new ArrayBuffer(Math.ceil(a*n*2))),v=a*u|0,w=a*n|0;for(o=0;o!==v;o++)f=l*(o/(a*u))*p.call(m,o,a,h,l),y[o<<1]=f,y[1+(o<<1)]=f>>8;for(;o!==w;o++)f=l*Math.pow(1-(o-a*u)/(a*(n-u)),g)*p.call(m,o,a,h,l),y[o<<1]=f,y[1+(o<<1)]=f>>8;var x=["RIFF",this._pack(1,52),"WAVE","fmt ",this._pack(1,16),this._pack(0,1),this._pack(0,d),this._pack(1,a),this._pack(1,a*d*c/8),this._pack(0,d*c/8),this._pack(0,c),"data",this._pack(1,y.length*d*c/8),y],_=new this.Blob(x,{type:"audio/wav"}),S=this.URL.createObjectURL(_);return this._fileCache[t][s-1][e][n]=S,S}play(t,e,s,i){var r=this.generate(t,e,s,i);return new Audio(r).play(),!0}debug(){this._debug=!0}listSounds(){for(var t=[],e=0;e<this._sounds.length;e++)t.push(this._sounds[e].name);return t}__init__(){this._resizeCache()}loadSoundProfile(){for(var t=0,e=arguments.length;t<e;t++){let e=arguments[t];if(!(e instanceof Object))throw new Error("Invalid sound profile.");this._sounds.push(e)}return this._resizeCache(),!0}loadModulationFunction(){for(var t=0,e=arguments.length;t<e;t++){let e=arguments[t];if("function"!=typeof e)throw new Error("Invalid modulation function.");this._mod.push(e)}return!0}}const Synth=new AudioSynth;Synth.loadModulationFunction((function(t,e,s,i){return 1*Math.sin(2*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return 1*Math.sin(4*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return 1*Math.sin(8*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return 1*Math.sin(.5*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return 1*Math.sin(.25*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return.5*Math.sin(2*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return.5*Math.sin(4*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return.5*Math.sin(8*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return.5*Math.sin(.5*Math.PI*(t/e*s)+i)}),(function(t,e,s,i){return.5*Math.sin(.25*Math.PI*(t/e*s)+i)}));const piano={name:"piano",attack:function(){return.002},dampen:function(t,e,s){return Math.pow(.5*Math.log(e*s/t),2)},wave:function(t,e,s,i){var r=this.modulate[0];return this.modulate[1](t,e,s,Math.pow(r(t,e,s,0),2)+.75*r(t,e,s,.25)+.1*r(t,e,s,.5))}},outOfTunePiano=Object.assign({},piano,{wave:function(t,e,s,i){var r=this.modulate[0];return this.modulate[1](t,e,.023*s,Math.pow(r(t,e,s,0),2)+.75*r(t,e,s,.25)+.1*r(t,e,s,.5))}});Synth.loadSoundProfile(piano,outOfTunePiano);const PIANO=0,OUT_OF_TUNE_PIANO=1;class TextUtil{constructor(t){this.g=t}centeredTexts(t,e,s,i,r){const o=this.g,n=.2*e;let h=1===t.length?t[0].length:t.reduce((t,e)=>t.length>e.length?t.length:e.length);return t.map((t,a)=>o.text(t,`${e}px monospace`,s,o.stage.halfWidth-h/2*((e+n)/2),i+r*a))}centeredText(t,e,s,i){const r=.2*e,o=this.g;return o.text(t,`${e}px monospace`,s,o.stage.halfWidth-t.length/2*((e+r)/2),i)}}const fill=function(t,e=" "){return Array(Math.max(0,t)).fill(e).join("")},rpad=function(t,e,s=" "){return t+fill(e-t.length,s)},lpad=function(t,e,s=" "){return fill(e-t.length,s)+t},WHITE_KEYS=0,ALL_KEYS=1,SHOW_ALL_NOTES=0,SHOW_FIRST_NOTE=1,KEY_MODE=0,HIGHLIGHT_MODE=1,notes=["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5"],controls=["A","W","S","E","D","F","T","G","Y","H","U","J","K"],controlMap={};notes.forEach((t,e)=>controlMap[t]=controls[e]);class Keyboard{constructor(t,e){this.g=t,this.textUtil=new TextUtil(t),this.initControls(),this.createKeys(),this.initMidi(),this.waitForNote=!1,this.lockedInput=!1,this.onWinScreen=!1,this.gameOver=!1,this.menuStep=KEY_MODE,this.started=!1,this.repeated=!1,this.hud=e,this.totalNotes=0,this.correctNotes=0,this.prevCorrectNotes=0,this.level=1,this.subLevel=1,this.showMenu(),this.resetScore()}resetScore(){this.score={[HAPPY]:0,[SAD]:0,[ANGRY]:0},this.totalNotes=0,this.correctNotes=0}initMidi(){navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(t=>{for(var e of t.inputs.values())e.onmidimessage=t=>{if(159===t.data[0]&&t.data[1]>=60&&t.data[1]<73){const e=t.data[1]-60,s=notes[e].match(/^(\D+)(\d)$/);this.playNoteAsPlayer(s[1],s[2])}}})}showMenu(){this.hud.setText("Select Mode"),this.menuTexts=this.textUtil.centeredTexts(["White Keys (Easier)","All Keys   (Harder)"],18,colors.black,40,32),this.cursor=new Slime(this.g),this.cursor.setMood(HAPPY),this.cursor.sprite.y=this.menuTexts[0].y,this.cursor.sprite.x=this.menuTexts[0].x-24,this.keyMode=WHITE_KEYS,this.highlightMode=SHOW_ALL_NOTES,this.hud.setFooterText("Select mode with arrows keys and press Enter")}showMenuStep2(){this.menuStep=HIGHLIGHT_MODE,this.g.remove(this.menuTexts),this.menuTexts=this.textUtil.centeredTexts(["Show All Notes  (Easier)","Show First Note (Harder)"],18,colors.black,40,32),this.cursor.sprite.y=this.menuTexts[0].y,this.cursor.sprite.x=this.menuTexts[0].x-24}start(){this.started=!0,this.g.remove(this.menuTexts),this.g.remove(this.cursor.sprite),this.startTime=new Date,this.melodyLength=2,this.startRound(),this.hud.setFooterText("Level 1-1")}reset(){this.texts&&this.g.remove(this.texts),this.winScreenSlimes&&this.g.remove(this.winScreenSlimes.map(t=>t.sprite)),this.texts=[],this.winScreenSlimes=[],this.started=!1,this.menuStep=KEY_MODE,this.highlightMode=SHOW_ALL_NOTES,this.onWinScreen=!1,this.gameOver=!1,this.level=1,this.subLevel=1,this.hud.setFooterText(" "),this.resetScore(),this.resetSlimes(),this.showSlimes(),this.showKeyboard(),this.showMenu()}startRound(){this.hud.setText("Listen"),this.resetSlimes(),this.prevCorrectNotes=this.correctNotes,this.generateMelody()}showResults(){let t=0;if(this.lockedInput=!0,Object.keys(this.keys).forEach(e=>{t+=this.keys[e].slime.mood,this.score[this.keys[e].slime.mood]++}),this.correctNotes-this.prevCorrectNotes===this.melodyLength)this.hud.setText("Perfect!");else if(0===t)this.hud.setText("Acceptable");else if(t>0)this.hud.setText("Nice!");else{const t=["The slimes don't want to play anymore","The slimes have lost the music in their hearts","The slimes just remembered they have a thing","The slimes are kicking you out of the band"];this.hud.setText("Game Over",this.g.randomPick(t)),this.hud.setFooterText("Press Enter to restart"),this.gameOver=!0}t>=0&&(8===this.subLevel&&this.level===(this.keyMode===WHITE_KEYS?2:3)?this.showWinScreen():(this.subLevel<8?this.subLevel++:(this.level++,this.subLevel=1),setTimeout(()=>{this.startRound(),this.hud.setFooterText(`Level ${this.level}-${this.subLevel}`)},2e3)))}showWinScreen(){this.keyMode===WHITE_KEYS?this.hud.setText("Well Done!","Try all keys mode to proceed to level 3"):this.hud.setText("You Win!"),this.hud.setFooterText("Press Enter to restart"),this.endTime=new Date,this.hideSlimes(),this.hideKeyboard();const t=this.correctNotes/this.totalNotes*100,e=(this.endTime.getTime()-this.startTime.getTime())/1e3,s=Math.floor(e/60).toString(),i=(e%60).toFixed(3),r=(this.keyMode===WHITE_KEYS?"White Keys | ":"All Keys | ")+(this.highlightMode===SHOW_ALL_NOTES?"Show All":"Show First");this.texts=this.textUtil.centeredTexts([" ",rpad("Mode",16)+r,rpad("Correct Notes",16)+`${t.toFixed(2)}%`,rpad("Time",16)+`${lpad(s,2,"0")}:${lpad(i,6,"0")}`,lpad(" ".toString(),16)+lpad(this.score[HAPPY].toString(),3),lpad(" ".toString(),16)+lpad(this.score[SAD].toString(),3),lpad(" ".toString(),16)+lpad(this.score[ANGRY].toString(),3)],18,colors.black,50,50),this.winScreenSlimes=[new Slime(this.g),new Slime(this.g),new Slime(this.g)],this.winScreenSlimes[0].setMood(HAPPY),this.winScreenSlimes[1].setMood(SAD),this.winScreenSlimes[2].setMood(ANGRY);for(let t=0;t<3;t++)this.winScreenSlimes[t].sprite.y=this.texts[t+4].y,this.winScreenSlimes[t].sprite.x=this.texts[t+4].x+12;this.onWinScreen=!0}toggleMode(){if(this.started)return;let t;this.menuStep===KEY_MODE?(this.keyMode===ALL_KEYS?this.keyMode=WHITE_KEYS:this.keyMode=ALL_KEYS,t=this.keyMode):(this.highlightMode===SHOW_ALL_NOTES?this.highlightMode=SHOW_FIRST_NOTE:this.highlightMode=SHOW_ALL_NOTES,t=this.highlightMode),this.cursor.sprite.x=this.menuTexts[t].x-24,this.cursor.sprite.y=this.menuTexts[t].y}initControls(){this.controls=getControls(this.g),notes.forEach(t=>{this.controls[t].press=()=>this.playNoteAsPlayer(t.replace("4",""),t.charAt(t.length-1))}),this.controls.C5.press=()=>this.playNoteAsPlayer("C",5),this.controls.confirm.press=()=>{this.onWinScreen||this.gameOver?this.reset():this.started?this.repeated||(this.playMelody(this.melody.slice()),this.repeated=!0):0===this.menuStep?this.showMenuStep2():this.start()},this.controls.up.press=this.toggleMode.bind(this),this.controls.down.press=this.toggleMode.bind(this)}endRoundIfMelodyOver(){return!this.lockedInput&&0===this.melody.length&&(this.lockedInput=!0,this.repeated=!1,this.showResults(),1===this.subLevel?this.melodyLength=2:this.melodyLength++,!0)}playNoteAsPlayer(t,e){if(!this.lockedInput)if(this.waitForNote){if(this.waitForNote!==`${t}${e}`)return;this.playNote(t,e,colors.blue),this.waitForNote=!1,this.melody.shift(),this.endRoundIfMelodyOver()||this.hud.setText("Continue")}else if(this.melody&&this.melody.length){const s=this.keys[`${t}${e}`];if(this.melody[0]===`${t}${e}`)this.playNote(t,e,colors.blue),this.melody.shift(),s.onCorrectNote(this.endRoundIfMelodyOver.bind(this)),this.correctNotes++,this.hud.setText("Play");else if(s.slime.mood!==ANGRY){this.waitForNote=this.melody[0],this.playNote(t,e,colors.red,OUT_OF_TUNE_PIANO),this.keys[this.melody[0]].highlight(colors.lightBlue),s.onWrongNote(),this.hud.setText("Play correct note to continue")}else s.highlight(colors.red,.25),this.hud.setText("Slime is angry","Play another key")}else this.waitForNote||this.playNote(t,e,colors.blue)}playNote(t,e,s=null,i=PIANO){Synth.play(i,t,e-1),s&&this.keys[`${t}${e}`].highlight(s,.25)}updateSlimes(t){Object.keys(this.keys).forEach(e=>{t(this.keys[e].slime)})}resetSlimes(){this.updateSlimes(t=>t.resetMood())}hideSlimes(){this.updateSlimes(t=>t.sprite.visible=!1)}showSlimes(){this.updateSlimes(t=>t.sprite.visible=!0)}hideKeyboard(){Object.keys(this.keys).forEach(t=>{this.keys[t].sprite.visible=!1,this.keys[t].text.visible=!1})}showKeyboard(){Object.keys(this.keys).forEach(t=>{this.keys[t].sprite.visible=!0,this.keys[t].text.visible=!0})}generateMelody(){const t={1:{scale:"Pentatonic",keys:["C","F","G"]},2:{scale:"Major",keys:"C"}},e={1:{Pentatonic:[2,2,3,2],"Whole Tone":[2,2,2,2,2],Blues:[3,2,1,1,3,2]},2:{Major:[2,2,1,2,2,2,1],"Jazz Minor":[2,1,2,2,2,2,1],"Harmonic Minor":[2,1,2,2,1,3,1]},3:{Diminished:[1,2,1,2,1,2,1,2],Chromatic:[1,1,1,1,1,1,1,1,1,1,1]}}[this.level],s=e[this.keyMode===WHITE_KEYS?t[this.level].scale:this.g.randomPick(Object.keys(e))],i={};notes.forEach((t,e)=>{"C5"!==t&&(i[t.replace("4","")]=(t=>{const e=[t];return s.forEach((i,r)=>{if(t>0&&r===s.length-1)return;let o=e[e.length-1]+i;t>0&&(o%=12),e.push(o)}),e})(e))});const r=this.keyMode===WHITE_KEYS?this.g.randomPick(t[this.level].keys):this.g.randomPick(Object.keys(i)),o=i[r],n=notes.filter((t,e)=>o.indexOf(e)>-1),h=[this.g.randomPick(n)];for(let t=1;t<this.melodyLength;t+=1)if(h.length>1){const t=h[h.length-1],e=h[h.length-2],s=Math.max(notes.indexOf(t),notes.indexOf(e))-Math.min(notes.indexOf(t),notes.indexOf(e)),i=n.filter((e,s)=>s>n.indexOf(t)),r=n.filter((e,s)=>s<n.indexOf(t)),o={};i.length&&(o.asc=i),r.length&&(o.desc=r);const a=this.g.randomPick(Object.keys(o)),l=o[a];s<5?h.push(this.g.randomPick(l)):"asc"===a?h.push(l[0]):h.push(l[l.length-1])}else h.push(this.g.randomPick(n.filter(t=>t!==h[0])));this.melody=h.slice(),this.keys[h[0]].slime.setMood(HAPPY),this.playMelody(h),this.totalNotes+=this.melodyLength}playMelody(t){if(this.lockedInput=!0,t.length){const e=t.length===this.melodyLength,s=t.shift();(this.highlightMode===SHOW_ALL_NOTES||e)&&this.keys[s].slime.jump();const i=s.charAt(s.length-1),r=s.replace(/\d/,"");this.playNote(r,i,this.highlightMode!==SHOW_FIRST_NOTE||e?colors.lightBlue:null);const o=1e3-Math.min(80*this.melodyLength,800);window.setTimeout(()=>{this.playMelody(t)},o)}else this.lockedInput=!1,this.repeated?this.hud.setText("Play"):this.hud.setText("Enter to repeat or start playing")}createKeys(){this.keys={},notes.filter(t=>2==t.length).forEach((t,e)=>{this.keys[t]=new WhiteKey(this.g,e,controlMap[t])}),notes.filter(t=>3===t.length).forEach((t,e)=>{this.keys[t]=new BlackKey(this.g,e,controlMap[t])})}update(){Object.keys(this.keys).forEach(t=>{this.keys[t].update()})}}class Hud{constructor(t){this.g=t,this.textUtil=new TextUtil(t)}setText(t,e=" "){this.text&&this.text.content===t&&this.subText&&this.subText.content===e||(this.text&&this.g.remove(this.text),this.text=this.textUtil.centeredText(t,24,colors.black,0),this.subText&&this.subText.content===e||(this.subText&&this.g.remove(this.subText),this.subText=this.textUtil.centeredText(e,18,colors.black,42)))}setFooterText(t){this.footerText&&this.footerText.content===t||(this.footerText&&this.g.remove(this.footerText),this.footerText=this.textUtil.centeredText(t,18,colors.black,this.g.stage.height-32))}}var gameState=t=>{const e=new Hud(t),s=new Keyboard(t,e);return()=>{s.update()}},g=ga(805,640,()=>{g.canvas.style.display="block",g.canvas.style.margin="auto",g.backgroundColor="white",g.state=gameState(g)},["assets/neutral-slime.png","assets/happy-slime.png","assets/sad-slime.png","assets/angry-slime.png"]);g.start();
